<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Portfolio Tracker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { padding: 20px; background-color: #f8f9fa; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .header { margin-bottom: 30px; padding-bottom: 15px; border-bottom: 1px solid #dee2e6; }
        .metrics-container { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px; }
        .metric-card { flex: 1; min-width: 200px; padding: 15px; border-radius: 8px; background-color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .metric-big { font-size: 1.5rem; font-weight: 700; }
        .metric-small { font-size: 1.25rem; font-weight: 600; }
        .metric-label { font-size: 0.9rem; color: #6c757d; margin-bottom: 5px; }
        .metric-positive { color: #28a745; }
        .metric-negative { color: #dc3545; }
        .portfolio-table th, .market-table th { background-color: #f1f3f9; font-weight: 600; }
        .action-buttons { display: flex; gap: 5px; }
        .chart-container { height: 300px; margin-top: 30px; }
        .last-updated { font-size: 0.85rem; color: #6c757d; text-align: right; margin-bottom: 10px; }
        .market-search { margin-bottom: 20px; }
        .section-title { margin-bottom: 20px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; }
    </style>
</head>
<body>
<div class="container">
    <div class="header d-flex justify-content-between align-items-center">
        <h1 class="mb-0">Portfolio Tracker</h1>
        <div>
            <button class="btn btn-outline-primary me-2" onclick="showTab('crypto-market')">
                <i class="bi bi-currency-bitcoin"></i> Crypto
            </button>
            <button class="btn btn-primary" onclick="refreshPortfolio()">
                <i class="bi bi-arrow-repeat"></i> Refresh
            </button>
        </div>
    </div>

    <ul class="nav nav-tabs" id="portfolioTabs">
        <li class="nav-item">
            <a class="nav-link active" id="portfolio-tab" onclick="showTab('portfolio')">Portfolio</a>
        </li>
        <li class="nav-item">
            <a class="nav-link" id="crypto-market-tab" onclick="showTab('crypto-market')">Crypto Market</a>
        </li>
    </ul>

    <!-- PORTFOLIO -->
    <div id="portfolio-content">
        <div class="section-title">
            <h2><i class="bi bi-currency-bitcoin"></i> Crypto Portfolio</h2>
        </div>

        <div class="metrics-container">
            <div class="metric-card">
                <div class="metric-label">TOTAL CRYPTO INVESTMENT</div>
                <div class="metric-big" id="cryptoTotalInvestment">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CURRENT CRYPTO VALUE</div>
                <div class="metric-small" id="cryptoCurrentValue">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CRYPTO PROFIT/LOSS</div>
                <div class="metric-big" id="cryptoProfitLoss">$0.00</div>
            </div>
            <div class="metric-card">
                <div class="metric-label">CRYPTO ROI</div>
                <div class="metric-small" id="cryptoRoiValue">0.00%</div>
            </div>
        </div>

        <div class="last-updated" id="lastUpdated">Last updated: never</div>

        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h3 class="mb-0">Your Crypto Assets</h3>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover portfolio-table">
                        <thead class="table-light">
                        <tr>
                            <th>Symbol</th>
                            <th>Name</th>
                            <th>Quantity</th>
                            <th>Avg Purchase Price</th>
                            <th>Total Investment</th>
                            <th>Current Price</th>
                            <th>Current Value</th>
                            <th>Profit/Loss</th>
                            <th>ROI</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="crypto-portfolio-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card chart-container mt-4" id="crypto-allocation-container" style="display:none;">
            <div class="card-header">
                <h3 class="mb-0">Crypto Asset Allocation</h3>
            </div>
            <div class="card-body d-flex align-items-center justify-content-center">
                <canvas id="cryptoAllocationChart"></canvas>
            </div>
        </div>
    </div>

    <!-- MARKET -->
    <div id="crypto-market-content" style="display:none;">
        <div class="card">
            <div class="card-header">
                <h2 class="mb-0">Crypto Market</h2>
            </div>
            <div class="card-body">
                <div class="market-search mb-4">
                    <div class="input-group">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input type="text" class="form-control" id="cryptoMarketSearch" placeholder="Search cryptocurrencies..." oninput="filterCrypto()">
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover market-table">
                        <thead class="table-light">
                        <tr>
                            <th>Rank</th>
                            <th>Name</th>
                            <th>Symbol</th>
                            <th>Price</th>
                            <th>24h Change</th>
                            <th>Market Cap</th>
                            <th>Actions</th>
                        </tr>
                        </thead>
                        <tbody id="crypto-market-table-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Asset Modal -->
    <div class="modal fade" id="addCryptoAssetModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog"><div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add to Portfolio</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addCryptoAssetForm">
                    <div class="mb-3">
                        <label class="form-label">Asset</label>
                        <div class="d-flex align-items-center">
                            <img src="" id="cryptoAssetIcon" class="me-2" width="24" height="24">
                            <span id="cryptoAssetNameDisplay"></span>
                            <span class="ms-2 text-muted" id="cryptoAssetSymbolDisplay"></span>
                        </div>
                        <input type="hidden" id="cryptoAssetId">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Amount to Invest ($)</label>
                        <input type="number" class="form-control" id="cryptoInvestmentAmount" min="1" step="0.01" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Current Price per Coin</label>
                        <div class="price-container d-flex align-items-center gap-2">
                            <span id="cryptoCurrentPriceDisplay">Loading...</span>
                            <div class="spinner-border spinner-border-sm" id="cryptoPriceSpinner"></div>
                        </div>
                        <input type="hidden" id="cryptoPurchasePrice">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Purchase Date</label>
                        <input type="date" class="form-control" id="cryptoPurchaseDate" required>
                    </div>
                    <div class="alert alert-info info-alert">
                        <i class="bi bi-info-circle"></i>
                        <span id="cryptoQuantityPreview">Enter investment amount to see quantity</span>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button class="btn btn-primary" id="addCryptoAssetBtn" disabled>Add Asset</button>
            </div>
        </div></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const API = {
        portfolio: '/api/portfolio',
        marketTop: (limit=100) => `/api/market/top?limit=${limit}`,
        price: id => `/api/market/price/${id}`
    };

    let cryptoMarketData = [];
    let cryptoAllocationChart;

    document.addEventListener('DOMContentLoaded', () => {
        loadPortfolio();
        loadCryptoMarket();

        const today = new Date();
        document.getElementById('cryptoPurchaseDate').value = formatDate(today);

        document.getElementById('cryptoInvestmentAmount').addEventListener('input', updateCryptoQuantityPreview);
        document.getElementById('addCryptoAssetBtn').addEventListener('click', addCryptoAssetToPortfolio);
    });
    


    function showTab(tabName){
        document.getElementById('portfolio-content').style.display = 'none';
        document.getElementById('crypto-market-content').style.display = 'none';
        document.getElementById('portfolio-tab').classList.remove('active');
        document.getElementById('crypto-market-tab').classList.remove('active');

        if (tabName==='portfolio'){
            document.getElementById('portfolio-content').style.display='block';
            document.getElementById('portfolio-tab').classList.add('active');
        } else {
            document.getElementById('crypto-market-content').style.display='block';
            document.getElementById('crypto-market-tab').classList.add('active');
        }
    }

    function formatDate(d){
        const y=d.getFullYear();
        const m=String(d.getMonth()+1).padStart(2,'0');
        const day=String(d.getDate()).padStart(2,'0');
        return `${y}-${m}-${day}`;
    }

    async function loadPortfolio(){
        try{
            const res = await fetch(API.portfolio);
            if(!res.ok) throw new Error('Failed to load portfolio');
            const aggregated = await res.json();
            renderCryptoPortfolio(aggregated);
            updateCryptoAllocationChart(aggregated);

            document.getElementById('lastUpdated').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }catch(e){
            console.error(e);
        }
    }
    




    async function loadCryptoMarket(){
        const tb = document.getElementById('crypto-market-table-body');
        tb.innerHTML = `<tr><td colspan="7" class="text-center py-4">
          <div class="spinner-border text-primary"></div>
          <p class="mt-2">Loading cryptocurrency data...</p></td></tr>`;
        try{
            const res = await fetch(API.marketTop(100));
            if(!res.ok) throw new Error('Market API error');
            cryptoMarketData = await res.json();
            renderCryptoMarket(cryptoMarketData);
        }catch(err){
            tb.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">
                <i class="bi bi-exclamation-circle"></i>
                <p>Failed to load cryptocurrency data</p>
                <p class="small">${err.message||'Unknown error'}</p>
                <button class="btn btn-sm btn-outline-primary" onclick="loadCryptoMarket()">
                    <i class="bi bi-arrow-repeat"></i> Try again
                </button></td></tr>`;
        }
    }

    function filterCrypto(){
        const q = document.getElementById('cryptoMarketSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#crypto-market-table-body tr');
        rows.forEach(row=>{
            const name = row.querySelector('td:nth-child(2)')?.textContent.toLowerCase() || '';
            const sym = row.querySelector('td:nth-child(3)')?.textContent.toLowerCase() || '';
            row.style.display = (name.includes(q) || sym.includes(q)) ? '' : 'none';
        });
    }

    function renderCryptoMarket(list){
        const tb = document.getElementById('crypto-market-table-body');
        tb.innerHTML = '';
        list.forEach(crypto=>{
            const changeClass = (crypto.change24h ?? 0) >= 0 ? 'metric-positive' : 'metric-negative';
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${crypto.rank ?? 'N/A'}</td>
                <td>
                  <div class="d-flex align-items-center">
                    <img src="${crypto.image}" width="24" height="24" class="me-2"
                         onerror="this.onerror=null;this.src='https://via.placeholder.com/24?text=?'">
                    ${crypto.name}
                  </div>
                </td>
                <td>${crypto.symbol}</td>
                <td>$${formatPrice(crypto.price)}</td>
                <td class="${changeClass}">${signed(crypto.change24h ?? 0)}%</td>
                <td>$${formatMarketCap(crypto.marketCap)}</td>
                <td><button class="btn btn-sm btn-outline-primary"
                        onclick="openAddCryptoModal('${crypto.id}','${crypto.name}','${crypto.symbol}','${crypto.image}')">
                        <i class="bi bi-plus-circle"></i> Add
                    </button></td>
            `;
            tb.appendChild(row);
        });
    }

    function formatPrice(p){
        if (p == null) return 'N/A';
        return Number(p).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: p < 1 ? 8 : 2});
    }
    function signed(x){ const v = Number(x||0).toFixed(2); return (x>=0?'+':'')+v; }
    function formatMarketCap(v){
        if (v == null) return 'N/A';
        const n = Number(v);
        if (n>=1e12) return (n/1e12).toFixed(2)+'T';
        if (n>=1e9)  return (n/1e9 ).toFixed(2)+'B';
        if (n>=1e6)  return (n/1e6 ).toFixed(2)+'M';
        if (n>=1e3)  return (n/1e3 ).toFixed(2)+'K';
        return n.toLocaleString();
    }

    async function openAddCryptoModal(id,name,symbol,imageUrl){
        document.getElementById('cryptoInvestmentAmount').value = '';
        document.getElementById('addCryptoAssetBtn').disabled = true;

        document.getElementById('cryptoAssetId').value = id;
        document.getElementById('cryptoAssetNameDisplay').textContent = name;
        document.getElementById('cryptoAssetSymbolDisplay').textContent = symbol.toUpperCase();

        const icon = document.getElementById('cryptoAssetIcon');
        icon.src = imageUrl;
        icon.onerror = function(){ this.src='https://via.placeholder.com/24?text=?' };

        document.getElementById('cryptoPurchaseDate').value = formatDate(new Date());
        const priceSpinner = document.getElementById('cryptoPriceSpinner');
        const priceSpan = document.getElementById('cryptoCurrentPriceDisplay');
        priceSpinner.style.display='inline-block';
        priceSpan.textContent='Loading...';

        try{
            const res = await fetch(API.price(id));
            const data = await res.json();
            const p = data.price || 0;
            document.getElementById('cryptoPurchasePrice').value = p;
            priceSpan.textContent = `$${Number(p).toLocaleString(undefined,{minimumFractionDigits:2, maximumFractionDigits:8})}`;
        }catch(e){
            priceSpan.textContent='Price unavailable';
        }finally{
            priceSpinner.style.display='none';
        }

        updateCryptoQuantityPreview();

        const modal = new bootstrap.Modal(document.getElementById('addCryptoAssetModal'));
        modal.show();
    }

    function updateCryptoQuantityPreview(){
        const amt = parseFloat(document.getElementById('cryptoInvestmentAmount').value);
        const price = parseFloat(document.getElementById('cryptoPurchasePrice').value);
        const sym = document.getElementById('cryptoAssetSymbolDisplay').textContent;
        const preview = document.getElementById('cryptoQuantityPreview');
        const btn = document.getElementById('addCryptoAssetBtn');

        if (!amt || amt<=0 || !price || price<=0){
            preview.innerHTML = "Enter investment amount to see quantity";
            btn.disabled = true;
            return;
        }
        const qty = amt / price;
        preview.innerHTML = `You will receive approximately: <strong>${qty.toFixed(6)} ${sym}</strong>`;
        btn.disabled = false;
    }


async function addCryptoAssetToPortfolio() {
    
        const id = document.getElementById('cryptoAssetId').value;
        const name = document.getElementById('cryptoAssetNameDisplay').textContent;
        const symbol = document.getElementById('cryptoAssetSymbolDisplay').textContent.toLowerCase();
        const amountInvested = parseFloat(document.getElementById('cryptoInvestmentAmount').value);
        const purchasePrice = parseFloat(document.getElementById('cryptoPurchasePrice').value);
        const purchaseDate = document.getElementById('cryptoPurchaseDate').value;

        if (!amountInvested || amountInvested <= 0 || isNaN(amountInvested)) {
            alert('Please enter a valid investment amount');
            return;
        }

        if (!purchasePrice || purchasePrice <= 0 || isNaN(purchasePrice)) {
            alert('Current price is unavailable. Please try again later.');
            return;
        }

        const quantity = amountInvested / purchasePrice;

        // Делаем объект под DTO
        const requestData = {
            symbol: id,                  // вместо assetId/assetSymbol
            assetName: name,
            quantity: quantity,
            purchasePrice: purchasePrice,
            purchaseDate: purchaseDate,
            totalInvestment: amountInvested
        };
       
    try {
        const response = await fetch("/api/portfolio", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                assetId: id,           // Изменить symbol на assetId
                assetName: name,
                assetSymbol: symbol,
                quantity: quantity,
                purchasePrice: purchasePrice,
                currentPrice: purchasePrice, // Явно передаем текущую цену
                amountInvested: amountInvested,
                purchaseDate: purchaseDate
            })
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "Failed to add asset");
        }
        
        alert("Asset successfully added!");
        // Закрыть модальное окно
        bootstrap.Modal.getInstance(document.getElementById('addCryptoAssetModal')).hide();
        // Обновить портфель
        loadPortfolio();
    } catch (error) {
        console.error(error);
        alert("Error: " + error.message);
    }
}
    

function renderCryptoPortfolio(items) {
    const body = document.getElementById('crypto-portfolio-table-body');
    body.innerHTML = '';

    let totalInvestment = 0;
    let totalCurrentValue = 0;
    let totalProfit = 0;

    items.forEach(asset => {
        const qty = Number(asset.totalQuantity || 0);
        const avg = Number(asset.avgPurchasePrice || 0);
        const investment = Number(asset.totalInvestment || 0); // Используем totalInvestment
        const currentPrice = Number(asset.currentPrice || 0);
        const currentValue = Number(asset.currentValue || 0);
        const profit = Number(asset.profit || 0);
        const roi = Number(asset.roiPercent || 0);

        totalInvestment += investment;
        totalCurrentValue += currentValue;
        totalProfit += profit; // Суммируем прибыль каждого актива

        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${asset.assetSymbol.toUpperCase()}</td>
            <td>${asset.assetName}</td>
            <td>${qty.toFixed(6)}</td>
            <td>$${avg.toFixed(2)}</td>
            <td>$${investment.toFixed(2)}</td>
            <td>$${currentPrice.toFixed(2)}</td>
            <td>$${currentValue.toFixed(2)}</td>
            <td class="${profit >= 0 ? 'metric-positive' : 'metric-negative'}">
                ${profit >= 0 ? '$' : '-$'}${Math.abs(profit).toFixed(2)}
            </td>
            <td class="${roi >= 0 ? 'metric-positive' : 'metric-negative'}">
                ${roi >= 0 ? '+' : ''}${Math.abs(roi).toFixed(2)}%
            </td>
            <td>
                <button class="btn btn-sm btn-outline-danger" onclick="removeCryptoAsset('${asset.assetId}')">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        `;
        body.appendChild(row);
    });

    // Расчет общего ROI портфеля
    const totalRoi = totalInvestment > 0 ? (totalProfit / totalInvestment) * 100 : 0;

    document.getElementById('cryptoTotalInvestment').textContent = `$${totalInvestment.toFixed(2)}`;
    document.getElementById('cryptoCurrentValue').textContent = `$${totalCurrentValue.toFixed(2)}`;

    const pl = document.getElementById('cryptoProfitLoss');
    pl.textContent = totalProfit >= 0 ? `$${totalProfit.toFixed(2)}` : `-$${Math.abs(totalProfit).toFixed(2)}`;
    pl.className = totalProfit >= 0 ? 'metric-big metric-positive' : 'metric-big metric-negative';

    const roiEl = document.getElementById('cryptoRoiValue');
    roiEl.textContent = `${totalRoi >= 0 ? '+' : ''}${Math.abs(totalRoi).toFixed(2)}%`;
    roiEl.className = totalRoi >= 0 ? 'metric-small metric-positive' : 'metric-small metric-negative';
}

    function updateCryptoAllocationChart(items){
        const container = document.getElementById('crypto-allocation-container');
        const ctx = document.getElementById('cryptoAllocationChart').getContext('2d');

        const labels = [];
        const values = [];
        items.forEach(a=>{
            const v = Number(a.currentValue || 0);
            if (v>0){ labels.push(a.assetSymbol.toUpperCase()); values.push(v); }
        });

        if (values.length===0){ container.style.display='none'; return; }
        container.style.display='block';

        if (cryptoAllocationChart) cryptoAllocationChart.destroy();

        const colors = ['#4e73df','#1cc88a','#36b9cc','#f6c23e','#e74a3b','#858796','#5a5c69','#00cc99','#9966ff','#ff99cc','#ffcc00','#3399ff'];
        cryptoAllocationChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels,
                datasets: [{ data: values, backgroundColor: colors.slice(0, labels.length), hoverBackgroundColor: colors.slice(0, labels.length) }]
            },
            options: {
                maintainAspectRatio:false,
                plugins:{
                    legend:{ position:'right', labels:{ usePointStyle:true, padding:20 }},
                    tooltip:{ callbacks:{ label: (ctx)=>{
                        const total = ctx.chart._metasets[0].total || ctx.dataset.data.reduce((a,b)=>a+b,0);
                        const pct = Math.round((ctx.raw/total)*100);
                        return `${ctx.label}: $${Number(ctx.raw).toFixed(2)} (${pct}%)`;
                    }}}
                }
            }
        });
    }

    async function removeCryptoAsset(assetId){
        if(!confirm('Are you sure you want to remove this asset from your portfolio?')) return;
        await fetch(`${API.portfolio}/${assetId}`, { method:'DELETE' });
        await loadPortfolio();
    }

    function refreshPortfolio(){ loadPortfolio(); }
</script>
</body>
</html>
